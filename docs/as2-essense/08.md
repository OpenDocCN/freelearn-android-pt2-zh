# 第八章。排除故障

调试环境是集成开发环境最重要的特性之一。使用调试工具可以轻松优化应用程序并提高其性能。在 Android Studio 中编程时要不要使用调试工具？安卓工作室包括**达尔维克调试监控服务器** ( **DDMS** )调试工具。

在本章中，您将首先学习**运行**和**调试**选项，以及如何在您在前一章中学习创建的安卓虚拟设备中模拟您的应用程序。您将深入了解**调试器**、**控制台**和**日志文件**选项卡。您还将学习如何在使用调试器时使用断点。我们将以安卓工作室 DDMS 和层次视图中包含的高级调试器工具中可用的每个选项卡的信息来结束本章。

这些是我们将在本章中讨论的主题:

*   排除故障
*   日志猫
*   即时运行
*   设备监视器工具
*   层次视图

# 运行调试

安卓应用程序可以从安卓工作室使用 USB 连接在真实设备中运行或者使用模拟器在虚拟设备中运行。虚拟设备使得在不同类型的硬件和软件配置上测试我们的应用成为可能。在本章中，我们将使用模拟器来运行和调试我们的应用程序，因为它简单而灵活。

要直接运行应用程序，请导航至**运行** | **运行“应用程序”**。您也可以点击工具栏上的播放图标。要调试应用程序，导航至**运行** | **调试“应用程序”**或点击工具栏上的错误图标。如果你的应用已经在运行，你可以通过导航到**运行** | **将调试器附加到安卓进程**来启动调试模式。

当我们选择**调试‘app’**选项时，会打开一个选择设备的对话框。**连接设备**部分用于选择运行设备；列出了当前连接的真实或虚拟设备。**可用仿真器**部分用于启动仿真器的新实例；列出了可用的虚拟设备。您也可以使用**创建新仿真器**按钮，从该对话框创建新仿真器。该选项将打开在[第 6 章](06.html "Chapter 6. Tools")、*工具*中解释的虚拟设备配置对话框。该对话框中的最后一个选项是**为将来的启动使用相同的选择**复选框。如果您想以后跳过这一步，请选中此项。

从如下截图所示的**可用仿真器**部分选择[第 6 章](06.html "Chapter 6. Tools")、*工具*中创建的虚拟设备，点击**确定**。

![Running and debugging](img/B05459_08_01.jpg)

模拟器将被启动。下次我们运行或调试应用程序时，模拟器将会运行，因此我们将从**连接设备**部分选择它。

调试时，你会注意到，在安卓工作室的底部，如下一张截图所示，有一个新的面板，**调试**，包含两个选项卡:**调试器**和**控制台**。**安卓显示器**标签包含另外两个工具:**日志猫**和**显示器**。

![Running and debugging](img/B05459_08_02.jpg)

## 控制台

**控制台**显示在模拟器启动或运行时发生的事件。打开它检查消息，并检查模拟器和应用程序是否正确执行。应该出现的操作有:

*   **等待设备**:这是模拟器启动时的起点。
*   **上传文件**(`adb push`命令):该事件表示应用程序已打包并存储在设备中。
*   **安装**(安装命令):该事件表示应用程序正在设备中安装。安装后，应打印成功消息。
*   **启动应用程序**(`adb shell am start`命令):该事件发生在应用程序开始执行时。
*   **等待进程**:当应用程序正在运行，调试系统试图连接到设备中的应用程序进程时，会发生此事件。

在前面的步骤成功后，应用程序将在模拟器中可见。通过在文本输入中键入任意名称并点击**接受**按钮进行测试。问候语应该会改变。

## 调试器

**调试器**管理断点，控制代码的执行，并显示关于变量的信息。要在代码中添加断点，只需点击一行代码的左边缘。代码行旁边会出现一个红色的点，表示断点。要删除断点，请单击它。如果右键单击断点，在一个小对话框中会出现更多选项，您可以单击**更多打开断点**窗口，如下图所示:

![Debugger](img/B05459_08_03.jpg)

您也可以通过导航至**运行** | **查看断点来打开**断点**窗口...**。在**断点**窗口的左侧面板中，列出了你的应用的所有断点。您可以添加、删除或启用和禁用新断点。您可以启用**异常断点**，这将在您的应用程序运行时引发异常时触发。如果从左侧面板中选择一个断点，可以使用右侧面板进行配置。例如，您可以为断点设置一个条件，将消息记录到控制台，或者在遇到断点时将其删除。

在我们主要活动的`onAcceptClick`方法的条件语句中添加一个断点，再次调试应用，如图:

![Debugger](img/B05459_08_04.jpg)

在申请中输入您的姓名，点击**接受**按钮。当执行到达断点时，暂停执行，**调试器**选项卡打开。因为我们在分配文本之前在条件语句中添加了断点，所以我们的问候消息没有改变。

在调试器选项卡中，我们可以检查方法调用层次结构和变量在执行点的状态。可用变量是`v`方法的参数、`TextView`和`EditText`通过`findViewById`方法获得的对象以及对当前活动(`this`)的引用。展开名为`etName`的`EditText`对象，如下图所示，搜索`mText`属性。此属性应包含您之前键入的名称:

![Debugger](img/B05459_08_05.jpg)

右键单击`EditText`对象，打开包含更多选项的菜单，选择**评估表达式...**。**评估表达式**对话框允许您在选定对象的上下文中查询方法。例如，键入`etName.getText()`并按*进入*评估表达式。表达式的结果将如下图所示:

![Debugger](img/B05459_08_06.jpg)

当应用程序的执行在断点处停止时，您可以执行以下操作:

*   要在不进入方法调用的情况下执行下一行代码，您可以导航到**运行** | **跳过**，单击**调试**面板顶部工具栏中的按钮，或者按下该选项的键盘快捷键，通常是 *F8* 键。
*   要进入方法调用，您可以导航至**运行** | **进入**，点击**调试**面板顶部工具栏中的按钮，或按 *F7* 。
*   选择您想要进入的方法，导航至**运行** | **智能进入**或按*移动* + *F7* 。
*   要跳到代码中的光标位置，您可以导航到**运行** | **运行到光标**，单击**调试**面板顶部工具栏中的按钮，或按 *Alt* + *F9* 。
*   要恢复执行直到下一个断点，您可以导航至**运行** | **恢复程序**，点击**调试**面板左侧工具栏中的按钮，或按 *F9* 。
*   要停止执行，您可以导航至**运行** | **停止**，点击**调试**面板左侧工具栏中的按钮，或按*Ctrl*+*F2*(*Cmd*+*F2*OS X)。

除了其他选项之外，这些选项也可以作为图标快捷方式从调试器选项卡中获得。

展开`tvGreeting`对象，检查其`mText`属性的值。现在，跳过条件语句和`setText`方法的调用。注意`mText`属性的值是如何变化的，如下面的截图所示。最后，继续执行，以便问候消息在设备屏幕中发生变化。

![Debugger](img/B05459_08_07.jpg)

在`if`子句中创建一个新的断点。我们可以给端点添加一个条件，这样只有当用户输入的名称为`"no name"`时，执行才会暂停，否则执行会照常进行。下面的**断点**窗口截图显示了断点的详细信息:

![Debugger](img/B05459_08_08.jpg)

在断点的**条件**字段中，添加以下条件来比较用户在名称字段(`etName`)中键入的文本:

```java
etName.getText().toString().equals("no name")
```

现在，如果你在应用中写下你的名字，没有断点会暂停执行。如果输入`"no name"`，将在最近创建的断点处暂停执行。

## 日志猫

**日志猫**是安卓日志系统，显示安卓系统在运行设备中生成的所有日志消息。日志消息有几个重要级别。从**日志猫**标签，我们可以按这些级别过滤日志消息。例如，如果我们选择信息级别作为过滤器，将显示来自**信息**、**警告**和**错误**级别的消息。下图显示了这些级别:

![LogCat](img/B05459_08_09.jpg)

要从我们的代码中打印日志消息，我们需要导入`Log`类。这个类对于每个级别都有一个方法:详细的`v`方法、调试的`d`方法、信息的`i`方法、警告的`w`方法和错误级别的`e`方法。这些方法接收两个字符串参数。第一个字符串参数通常标识消息的源类，第二个字符串参数标识消息本身。为了识别源类，我们建议使用一个常量静态字符串标记。但是，在下一个示例中，我们直接使用字符串来简化代码。将以下日志消息添加到我们主要活动的`onAcceptClick`方法中:

```java
if(etName.getText().length() > 0) {
  Log.i("MainActivity", "Name read: " + etName.getText());
  tvGreeting.setText("Hello " + etName.getText());
} 
else {
  Log.w("MainActivity", "No name typed, greeting didn't change");
}
```

我们有一条日志消息通知我们从用户输入中获得的名称，如果用户没有键入名称，则有一条日志消息打印警告。移除我们之前创建的任何断点，然后调试应用程序。

**安卓监视器**中的**日志文件**标签默认打印了当前应用程序生成的日志消息。读取应用程序的消息有时会很复杂，您需要过滤消息。在**日志目录**选项卡中，有一个可扩展的列表，您可以根据日志消息的重要程度对其进行过滤。您也可以使用搜索字段来查找某些日志消息。还有一个可扩展的列表，可以配置一些额外的过滤器:**无过滤器**选项显示设备生成的所有日志；**仅显示选定的应用程序**选项仅显示您的应用程序生成的日志；并且**编辑过滤器配置**选项允许您创建更复杂的过滤器。选择**编辑过滤器配置**检查该选项。将打开一个创建过滤器的对话框，如下图所示:

![LogCat](img/B05459_08_10.jpg)

日志消息可以通过其**日志标签**、其**日志消息**或打印它们的包的名称使用正则表达式进行过滤。日志也可以通过 **进程标识** ( **进程标识**)或其级别进行过滤。

新建一个名为`MyApplication`的过滤器，通过**包名**写`com.example.myapplication`(我们的应用包名)进行过滤，点击**确定**。现在**日志猫**日志已经过滤，更容易阅读我们的消息。现在，执行以下步骤:

1.  关注**模拟器**窗口，在应用中输入名称，点击**接受**。观察我们的日志信息在**日志文件**视图中的打印方式。
2.  从申请中删除你的名字，点击**接受**。这一次，会打印一条警告消息。请注意每种消息使用的不同颜色。

## 监视器

**显示器**面板位于安卓工作室的右下角。选择运行应用程序的设备或仿真器，并从两个最大的可扩展列表中选择与应用程序对应的进程。有四种显示器可供选择:

*   **Memory**: This shows the free and allocated memory of the selected application over time, as shown in the following screenshot:

    ![Monitors](img/B05459_08_11.jpg)

*   **CPU**: This shows the CPU usage in real time of your app, as shown in the following screenshot:

    ![Monitors](img/B05459_08_12.jpg)

*   **Network**: This shows the network usage of your app, as shown in the following screenshot:

    ![Monitors](img/B05459_08_13.jpg)

*   **GPU**: This shows the GPU usage of your app, indicating the time to execute, process, prepare, and draw the frames, as shown in the following screenshot:

    ![Monitors](img/B05459_08_14.jpg)

# 瞬间跑

即时运行是安卓工作室 2.0 中引入的一项新功能，它允许您在设备上运行应用程序时更新应用程序，而无需构建新的 APK。此功能减少了部署时间。

即时运行需要 SDK 15 或更高版本，尽管建议使用 SDK 21 或更高版本。您还需要将您的安卓 Gradle 插件更新到 2.0 或更高版本。即时运行既适用于模拟器，也适用于真实设备。

首次部署应用程序后，您会注意到运行/调试图标已经更改，并且有一个额外的 thunderbolt 图标，例如下面截图中的调试图标:

![Instant run](img/B05459_08_15.jpg)

下次你点击**调试**按钮，安卓工作室会分析你代码中的变化，让你的应用部署更快，而不是创建一个新的 APK，做一个完整的部署。根据需要推送到应用程序的代码，有三种类型的更新:

*   **Hot swap**: This is the fastest swap. This type of swap is done if you change the code of an existing method. Android Studio will create a stub method with the new code and restart the current activity.

    如果您不希望安卓工作室在热插拔后重新启动当前活动，您可以在设置屏幕中禁用此行为。即时运行设置位于主设置的**构建、执行、部署**部分。以下屏幕截图显示了即时运行设置屏幕:

    ![Instant run](img/B05459_08_16.jpg)

    您可以通过禁用代码更改时的**重启活动**选项来禁用活动的重启。

*   **热交换**:如果您更改或移除现有资源，这种类型的交换就完成了。安卓工作室将始终重新启动当前活动，您不能禁用此行为。
*   **冷交换**:这是最慢的交换，需要 API 21 或者更高。如果该设备运行的应用编程接口低于 21，安卓工作室将创建一个新的 APK 并执行全面部署。如果代码中的更改是结构性的，例如更改父类、实现的接口、字段或方法签名，这种类型的交换就完成了。安卓工作室将重启你的应用。

如果您更改应用程序清单或任何影响应用程序清单的内容，例如清单中引用的资源，安卓工作室将部署新的构建。

更改应用中的一些代码，例如，将`Hello`短信更改为`Goodbye`短信:

```java
tvGreeting.setText("Goodbye " + etName.getText());
```

用迅雷点击**调试**按钮。由于你在一个方法中改变了代码，安卓工作室将进行一次热交换。当前活动重新启动时，您会注意到闪烁。

热插拔完成后，安卓工作室的底部会显示一条消息，如下图所示:

![Instant run](img/B05459_08_17.jpg)

正如您在消息中看到的，代码更改已经应用，并且当前活动已经重新启动。输入姓名，点击`ACCEPT`。短信是`Goodbye`的一条:

![Instant run](img/B05459_08_18.jpg)

从设置中禁用**代码更改重启活动**选项，以观察差异。将代码改回`Hello`短信，调试 app。现在没有闪烁，当热插拔完成时，Android Studio 中显示的消息现在不同了:

![Instant run](img/B05459_08_19.jpg)

当热交换完成时，模拟器中也会显示一条消息，如下图所示。在这种情况下，显示的消息是:*应用的代码更改没有活动重启*。

![Instant run](img/B05459_08_20.jpg)

现在更改一个资源，例如，将`EditText`的提示更改为以下内容:

```java
android:hint="Please, enter your name"
```

用迅雷点击**调试**按钮。既然你换了一个资源，安卓工作室这次会做一个热交换。您会注意到当前活动再次重新启动。安卓工作室的底部也会显示同样的消息:

![Instant run](img/B05459_08_21.jpg)

如果您想要完全禁用即时运行，您可以通过取消标记**启用即时运行以在部署时热交换代码/资源更改(默认启用)**选项，在设置屏幕中完成此操作。

# 安卓设备监视器

DDMS 是软件开发工具包中更先进的调试工具。可以通过**安卓设备监视器**工具从安卓工作室访问 DDMS。该工具能够监控真实设备和仿真器。

要打开 DDMS 视角，导航至**工具** | **安卓** | **安卓设备监视器**。您也可以点击工具栏上的安卓设备监视器图标。一个新的窗口将从 DDMS 的角度打开。

在窗口的左侧部分，显示了已连接设备的列表。目前，只列出了我们的虚拟设备。在**设备**部分，还显示了每个设备上运行的进程列表。我们应该能够在之前启动的设备进程中定位我们的应用程序。在**设备**部分的工具栏中，我们可以使用停止标志图标停止一个进程。我们还可以通过点击相机图标来拍摄虚拟设备的屏幕截图。其他一些选项将在后面解释。

在窗口的右侧部分，提供了有关该设备的详细信息。该信息分为七个选项卡:**线程**、**堆**、**分配跟踪器**、**网络统计**、**文件浏览器**、**仿真器控制**、**系统信息**。**同样融入了 DDMS 视角的 LogCat** 放置在窗户的底部。

## 螺纹

**线程**选项卡显示属于所选进程的线程列表。从**设备**部分选择我们的申请流程。进程由包名标识，在这种情况下`com.example.myapplication`，点击**设备**部分工具栏上的**更新线程**图标按钮，线程将被加载到标签的内容中:

![Threads](img/B05459_08_22.jpg)

第一列是线程的标识。**状态**列表示线程状态， **utime** 表示线程执行用户代码所花费的总时间， **stime** 表示线程执行系统代码所花费的总时间， **Name** 表示线程的名称。我们感兴趣的线程是那些花时间执行用户代码的线程。

如果我们在应用程序中创建主线程之外的线程，这个**线程**工具会很有用。我们可以检查它们是否在应用程序的某个点被执行，以及它们的执行时间是否适中。

### 方法分析

方法剖析是一种工具，用于衡量所选流程中方法执行的性能。测量的参数是调用次数和执行时花费的 CPU 时间。有以下两种类型的花费时间:

*   **独占时间**:这是执行一个方法所花费的时间。
*   **包含时间**:这是执行一个方法所花费的总时间。该度量包括方法中任何被调用的方法所花费的时间。这些被调用的函数被称为其 **子方法**。

要收集方法分析数据，请从**设备**部分选择我们的应用程序，然后单击**设备**部分工具栏中**更新线程**图标旁边的**开始方法分析**图标。将显示一个对话框，用于选择您喜欢的分析选项。**基于样本的分析**使用可配置的采样频率，对运行时性能影响较小的分析。安卓 4.4 及更高版本提供了基于示例的分析。**基于轨迹的分析**分析所有方法的入口和出口。

在应用程序中执行一些操作；例如，在我们的示例应用程序中，键入一个名称并单击**接受**按钮，以便执行主活动的`onAcceptClick`方法。点击**停止方法剖析**图标按钮，停止方法剖析。

当方法分析停止时，将在 DDMS 透视图中打开一个包含结果跟踪的新选项卡。在这个新选项卡的顶部，方法调用以时间图的形式表示；每一行都属于一个线程。在跟踪的底部，一个方法所花费的时间的摘要显示在一个表中。

按方法名称排序，搜索我们的`onAcceptClick`方法(`com.example.myapplication.MainActivity.onAcceptClick`)。单击它以展开关于其执行的详细信息。现在，请注意以下事实:

*   列出了`onAcceptClick`方法内部调用的子方法。我们可以看到`EditText.getText`方法、`Activity.findViewById`方法和`TextView.setText`方法，我们确实在方法内部直接调用了它们，如下面的截图所示。
*   通话次数详见**通话次数/总次数**一栏。例如，我们可以看到`Activity.findViewById`方法被调用了两次( **2/2** 值)—一次调用寻找`TextView`对象，第二次调用寻找`EditText`对象。
*   The **Exclusive time** columns have no values for the parent or children methods due to their own definition of this type of measured time:

    ![Method profiling](img/B05459_08_23.jpg)

方法剖析对于检测那些在执行上花费太多时间的方法并随后优化它们非常有用。我们可以确定最昂贵的方法，以避免不必要的调用。

## 堆

**堆**选项卡显示堆内存使用信息和所选进程的统计数据。选择申请流程，点击**设备**部分工具栏中的**更新堆**图标按钮启用。堆信息在**垃圾收集器** ( **GC** )执行后显示。若要强制执行，请单击**设备**部分的工具栏上的**导致垃圾收集**按钮或垃圾图标。

第一个表显示堆使用情况的摘要:总大小、已分配空间、可用空间和已分配对象的数量。 **Stats** 表按类型给出了堆中分配的对象的以下详细信息:对象数量(**计数**列)、这些对象的总大小(**总大小**列)、最小(**最小**列)和最大对象(**最大**列)、中间大小(**中间值**列)和平均大小(**平均值**列)。选择一种类型来加载底部条形图。

该图按大小(以字节为单位)显示了一种类型的对象计数。如果我们在图表上单击鼠标右键，我们可以更改其属性(标题、颜色、字体、标签等)，并将其保存为 PNG 格式的图像:

![Heap](img/B05459_08_24.jpg)

## 分配跟踪器

**分配跟踪器**选项卡显示所选进程的内存分配。选择申请流程，点击**开始跟踪**按钮，开始跟踪记忆信息。然后，点击**获取分配**按钮获取分配对象列表。

我们可以使用选项卡顶部的过滤器来过滤我们自己的类中分配的对象。在过滤器中输入我们的包名`com.example.myapplication`。对于每个对象，该表显示其分配大小(**分配大小**)、线程(**线程**)、对象或类(**已分配类**)以及对象的分配方法(**已在**中分配)。单击任何对象查看更多信息，例如，分配它的行号。

在下一张截图中可以看到，在主活动的`onAcceptClick`中分配了一个`java.lang.StringBuilder`对象。在底部，您可以查看其分配的详细信息:

![Allocation Tracker](img/B05459_08_25.jpg)

最后，点击**停止跟踪**按钮。

分配跟踪器对于在我们的应用程序中进行某些交互时检查正在分配的对象非常有用，以便提高内存使用率。

## 网络统计

**网络统计**选项卡显示我们的应用程序如何使用网络资源。要获取使用网络的任何应用程序的网络统计数据，请单击**开始**按钮。数据传输将开始出现在图表中。

网络统计有助于优化代码中的网络请求，并控制在某个执行点传输的数据。

## 文件浏览器

**文件浏览器**选项卡显示设备的整个文件系统。我们可以检查每个元素的大小、日期或权限。导航至`/data/app/`搜索我们的`com.example.myapplication.apk`应用包文件。

## 仿真器控制

**仿真器控制**选项卡允许我们仿真虚拟设备中的一些特殊状态或活动。我们可以在不同的环境和情况下测试我们的应用程序，以检查它的行为是否符合预期。如果我们的应用程序具有依赖于设备物理位置的特性，我们可以使用模拟位置。其中一些特殊状态是:

*   **电话状态**:这个可以让你选择语音和数据状态及其速度和延迟
*   **电话操作**:这个用来模拟来电或短信
*   **位置控制**:此用于设置设备的地理位置

## 系统信息

**系统信息**选项卡以图形形式显示设备的帧渲染时间、总 CPU 负载和总内存使用情况。我们可以搜索我们的应用程序，并轻松地将其与设备上运行的其他进程进行比较。

我们可以更改图形的属性，例如颜色、字体和标题，并且可以将它们保存为 PNG 格式的图像。要打开这些选项，右键单击图形元素。

当我们的应用程序在前台运行时，打开 CPU 负载并保存图表。然后，点击【从设备更新】按钮关闭应用程序并更新中央处理器负载。请注意两个图表之间的差异以及空闲百分比的增长，如下图所示:

![System Information](img/B05459_08_26.jpg)

## 层次视图

除了 DDMS 之外，安卓设备监视器还包含了第二个视角——T2 层级视图。在安卓设备的顶部栏上，您可以从一个视角切换到另一个视角。顶部栏中的两个选项显示在下一个屏幕截图中:

![Hierarchy View](img/B05459_08_27.jpg)

打开**层次视图**视角，从左侧列表中选择你的应用。在左侧面板中，点击以下图标(将视图层次加载到树形视图中的**动作):**

![Hierarchy View](img/B05459_08_28.jpg)

视图层次结构被加载，如下面的截图所示:

![Hierarchy View](img/B05459_08_29.jpg)

有三个不同的面板:

*   **树形视图**:此面板显示了完整视图层次的视图。
*   **树形视图**:该面板详细显示了视图层次结构的特定区域。在层级的底部，我们可以找到 ID 为`textView_greeting`的`TextView`、ID 为`editText_name`的`EditText`和 ID 为`button_accept`的`Button`。他们的父母都是`RelativeLayout`。
*   **布局视图**:此面板显示布局视图。

如果选择其中一个视图元素，可以看到其详细信息。以下截图显示了`button_accept`按钮的详细信息:

![Hierarchy View](img/B05459_08_30.jpg)

从左侧面板打开**视图属性**选项卡。可以查看按钮的属性，如为`mText`属性，值为`Accept`。

在**树状图**面板的顶部，有一些操作，比如将树状图保存为 PNG 图像，或者将窗口图层捕获为 Photoshop 文件。

# 总结

现在您知道了应用程序的不同启动选项，以及如何使用控制台和**日志文件**进行调试。我们还看到了如何调试应用程序，以及如何在每个可用的选项卡中解释 DDMS 提供的数据。

在下一章中，我们将使用安卓工作室为应用程序的发布做准备。首先，您将了解在发布模式下构建应用程序之前准备应用程序的必要步骤。您还将学习如何在`APK`文件中压缩应用程序，以及如何生成自己的`APK`文件。最后，你将学习如何获得你的开发者证书，以及如何生成一个签名的`APK`文件，使其准备好发布。