# 第九章。准备发布

在前一章中，您已经学习了足够的知识来测试和调试您的应用程序。你需要做些什么来准备你的申请发布？如何使用 Android Studio 做到这一点？

本章描述了使用安卓工作室准备应用程序发布的必要步骤。首先，您将了解**应用程序包**(**【APK】**)文件——安卓应用程序打包在中的 JAR 文件的变体。然后，您将了解如何在全面测试应用程序后对其进行更改。最后，我们将签署我们的 APK 文件，让它可以上传到谷歌游戏。

这些是我们将在本章中讨论的主题:

*   APK 档案
*   生成类型
*   准备发布
*   生成签名的 APK
*   登录发布模式

# 理解 APK 文件

安卓应用被打包在一个扩展名为`.apk`的文件中。这些文件只是压缩的 ZIP 文件，因此可以很容易地探索它们的内容。APK 文件通常包含以下内容:

*   `assets/`:这是一个包含应用程序资产文件的文件夹。这是我们项目中存在的同一个`assets`文件夹。
*   `META-INF/`:这个是包含我们证书的文件夹。
*   `lib/`:这是一个包含编译代码的文件夹，以防处理器需要。
*   `res/`:这是一个包含图像、字符串等应用资源的文件夹。
*   `AndroidManifest.xml`:这个是应用清单文件。
*   `classes.dex`:这是一个包含应用程序编译代码的文件。
*   `resources.arsc`:这是一个包含一些预编译资源的文件，比如二进制 XML 文件。

拥有 APK 文件允许在安卓操作系统上分发和安装应用程序。安卓应用可以按照你喜欢的方式进行分发:通过谷歌 Play、亚马逊 App store 或 Opera Mobile Store 等应用市场；通过自己的网站；或者甚至通过电子邮件发送给你的用户。如果您选择最后两个选项中的一个，请考虑到默认情况下，安卓会阻止从谷歌游戏以外的位置安装。您应该通知您的用户，他们需要在设备中禁用此限制，以便能够安装您的应用程序。他们必须通过导航到安卓设备中的**设置** | **安全**来检查**未知来源**选项。

# 构建类型

应用程序在构建时必须使用私钥进行签名。如果没有签名，应用程序就不能安装在设备中，甚至不能安装在模拟器中。要构建我们的应用程序，有两种类型:**调试**和**发布**。两个 APK 版本包含相同的文件夹和编译文件；区别在于用来签名的钥匙。两种模式解释如下:

*   **调试**:当我们在前面的章节中运行和测试我们的应用程序时，我们处于调试模式，但是我们没有密钥，也没有做任何事情来签署我们的应用程序。安卓软件开发工具包工具会自动创建一个调试密钥、一个别名和他们的密码来签署 APK。这个过程发生在我们用安卓工作室运行或调试应用程序时，我们没有意识到。我们不能发布用 SDK 工具创建的调试密钥签名的 APK。
*   **发布**:当发布我们的应用的时候，我们必须构建一个发布版本。Google Play 要求 APK 文件用证书签名，开发者为其保留私钥。在这种情况下，我们需要自己的私钥、别名和密码，并且需要将它们提供给构建工具。证书标识应用程序的开发人员，可以是自签名证书。证书机构无需在证书上签字。

将密钥与您的证书一起存放在安全的地方。要升级您的应用程序，您必须使用相同的密钥来上传新版本。如果您丢失了密钥存储，您将无法更新您的应用程序。您必须用不同的包名创建一个新的应用程序。

# 发布应用程序前的步骤

在您生成 APK 文件之前，有必要准备您的应用程序，以便在发布模式下构建它。请执行以下步骤:

1.  首先，确保您已经完全测试了您的应用程序。我们建议以下列方式测试您的应用程序:
    *   在使用最低要求平台的设备上
    *   在使用目标平台的设备上
    *   在使用最新可用平台的设备上
    *   在真实设备上，而不仅仅是模拟器上
    *   各种屏幕分辨率和尺寸
    *   如果您的应用程序支持的话
    *   如果您允许，可以在移动设备和平板电脑中切换到横向模式
    *   在不同的网络条件下，例如没有互联网连接或覆盖率低
    *   当您的设备上没有激活全球定位系统或其他定位服务时(如果您的应用程序使用全球定位系统或任何定位服务)
    *   当按下后退按钮时
2.  其次，我们必须检查应用程序打印的日志消息。打印一些日志消息可能会被视为安全漏洞。安卓系统生成的日志可以被捕获和分析，所以我们应该避免显示关于应用程序内部工作的关键信息。您还应该从应用程序清单文件中删除`android:debuggable`属性。您也可以将该属性设置为`false`。
3.  第三，如果您的应用程序与服务器通信，请检查配置的网址是否是生产网址。在调试阶段，您可能在预发布环境中引用了服务器的 URL。
4.  最后，从应用程序清单文件中为`android:versionCode`和`android:versionName`属性设置正确的值。版本代码是表示应用程序版本的数字(整数)。新版本应该有更大的版本代码。此代码用于确定设备上安装的应用程序是否是最新版本，或者是否有更新的版本。

版本名称是代表应用程序版本的字符串。与版本代码不同，版本名称对用户是可见的，并且出现在关于应用程序的公共信息中。对于用户来说，它只是一个信息丰富的版本名称，并不用于任何内部目的。

为版本代码指定值`1`，为版本名称指定值`1.0`。`manifest`标签应该如下所示:

```java
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.myapplication"
    android:versionCode="1"
    android:versionName="1.0" >
```

我们的应用程序的新版本的版本代码值为`2`，版本名称值为`1.1`:

```java
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.example.myapplication"
    android:versionCode="2"
    android:versionName="1.1" >
```

# 生成签名的 APK

要生成签名的 APK，导航至**构建** | **生成签名的 APK** 。选择**应用程序**模块，点击**下一步**按钮。在生成签名 APK 的对话框中，我们需要一个证书。这个证书上有 APK 的签名，这表明它属于我们。

如果这是我们的第一个应用程序，我们可能没有任何证书。点击**新建...**按钮打开**新钥匙库**对话框。现在，填写以下信息:

*   **密钥库路径**:这是您系统中创建密钥库的路径。密钥存储是扩展名为`.jks`的文件，例如`release_keystore.jks`。
*   **密码**:这是密钥库密码。你得确认一下。
*   **别名**:这是你证书的别名，是一对公钥和私钥。我们把它命名为`releasekey`。
*   **密码**:这是证书密码。你得确认一下。
*   **有效期(年)**:此为有效期至有效期日的证书。建议值为 25 年或更长。
*   **证件**:这是证件中包含的个人信息。键入您的名字和姓氏、组织单位、组织、城市或地方、州或省以及国家代码；例如`AS`为**组织单位**、`packtpub`为**组织**、`ES`为**国家代码**。

您可以在下一张截图中看到**新密钥存储**对话框:

![Generating a signed APK](graphics/B05459_09_01.jpg)

点击**确定**。创建签名 APK 的对话框现在加载了密钥存储数据。下一次我们创建一个已签名的 APK，我们将已经有一个证书，所以我们将选择**选择现有的**按钮。点击**下一步**按钮。下一步，选择保存 APK 文件的路径，选择发布版本类型，点击**完成**。APK 完全生成后，安卓工作室底部栏会有一条消息通知您，安卓工作室顶部会有以下通知:

![Generating a signed APK](graphics/B05459_09_02.jpg)

我们应该在选定的路径中创建APK 文件。现在您已经准备好发布 APK 文件，建议您在分发它之前在设备中再次测试它。

# 在释放模式下自动签名

当在调试模式下运行时，应用程序被自动签名，因为调试密钥是自动生成的。如果我们尝试在发布模式下运行我们的应用，将显示以下错误，因为安卓工作室不知道如何签署我们的应用:*错误:您当前选择的变体(app-release-unsigned.apk)的 apk 未签署。请为此变体(版本)*指定签名配置。

如果我们想在发布模式下运行我们的应用程序，我们需要配置我们的构建设置。

导航至**文件** | **项目结构，打开**项目结构**设置...**。在**模块**部分选择你的应用，打开**签约**标签。单击加号按钮创建新的签名配置。重命名配置并键入密钥存储的数据，如下图所示:

![Sign automatically in release mode](graphics/B05459_09_03.jpg)

切换到**构建类型**选项卡，其中默认列出了两种构建类型:调试和发布。选择**发布**，在**签名配置**选择器中选择最近创建的配置(**发布配置**:

![Sign automatically in release mode](graphics/B05459_09_04.jpg)

按**确定**完成配置。现在，您的应用程序将使用您的发布密钥在发布模式下自动签名。

这个签名配置实际上已经修改了你的 app 模块的`build.gradle`文件。打开此文件以观察更改:

*   使用以下代码添加了新的签名配置:

    ```java
    signingConfigs {
       releaseConfig {
          keyAlias 'releaseKey'
          keyPassword 'password'
          storeFile
             file('/Users/belen/release_keystore.jks')
          storePassword 'password'
       }
    }
    ```

*   发布构建类型现在指向之前的签名配置:

    ```java
    buildTypes {
       release {
          minifyEnabled false
          proguardFiles 
             getDefaultProguardFile('proguard-android.txt'),
             'proguard-rules.pro'
          signingConfig signingConfigs.releaseConfig
       }
    }
    ```

如果你不想让在`build.gradle`文件中公开你的密码，有种选择，例如，将你的密码保存在一个`properties`文件中，你可以从`build.gradle`文件中读取。

## 在发布模式下运行应用

现在我们的应用将自动签署进行发布，我们可以使用发布模式运行和测试我们的应用。要在发布模式下运行应用，请打开位于安卓工作室左侧栏的**构建变体**面板，如下图所示:

![Running your app in release mode](graphics/B05459_09_05.jpg)

您的应用程序模块显示在**构建变体**面板中，以及当前构建变体，默认为**调试**。将构建变量值更改为**发布**，然后您的应用程序就可以在发布模式下运行了。

## APK 分析仪

安卓工作室 2.2 引入了一项新功能——APK 分析仪。这个工具分析一个选中的 APK 文件的内容。您可以查看组件的大小、最终的`AndroidManifest.xml`文件和编译的资源。

导航至**构建** | **APK 分析仪**并选择您的 APK 文件。将打开一个新的选项卡，显示 APK 文件的详细信息，如下面的屏幕截图所示:

![APK Analyzer](graphics/B05459_09_06.jpg)

APK 中的所有文件都列出了它们的文件大小:**原始文件大小**和**下载大小**。下载大小是用户下载 APK 时对文件大小的估计。

当您选择一个文件时，您可以在底部看到它的详细信息。选择`classes.dex`文件，查看 APK 文件中所有类的列表，如下图所示:

![APK Analyzer](graphics/B05459_09_07.jpg)

对于每个类，显示方法的数量，并提供一个摘要。这些信息对于避免 64k 引用方法限制问题非常有用。一个**达尔维可执行文件** ( **dex** )字节码文件中可以引用的方法总数是有限制的:65536。使用 APK 分析仪，您可以跟踪您的 APK 的方法数量。

如果您的应用程序超出了限制，重构或代码清理还不够，您可以为您的应用程序启用多 ex 配置。多 ex 配置将创建不同的`dex`文件。在您的`build.gradle`文件的`defaultConfig`中添加以下行以启用多 ex:

```java
multiDexEnabled true
```

您还需要在清单文件中将`MultiDexApplication`类添加到您的应用程序中:

```java
android:name="android.support.multidex.MultiDexApplication"
```

# 总结

您学习了如何制作 APK 文件，以及如何修改应用程序以准备发布。您还学习了如何使用开发人员证书签署我们的应用程序。到本章结束时，您应该已经生成了一个准备发布的签名 APK。

在[附录](10.html "Appendix A. Getting Help")、*获取帮助*中，您将学习如何使用安卓工作室获取帮助。我们将访问安卓工作室在线文档并浏览帮助主题。最后，您将了解如何使用内置的更新功能来保持安卓工作室实例的更新。