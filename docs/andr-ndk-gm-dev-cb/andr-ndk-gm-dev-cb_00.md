# 前言

移动性和对高性能计算的需求往往是紧密相连的。当前的移动应用程序执行许多计算密集型操作，如 3D 和立体渲染、图像和音频识别、视频解码和编码，尤其是随着增强现实等新技术诞生。这包括移动游戏、3D 用户界面软件和社交软件，涉及媒体流处理。

在某种意义上，移动游戏开发由于硬件能力的限制、内存带宽的不足和宝贵的电池资源，迫使我们回到几年前，但也让我们重新考虑与用户互动的基本形式。

基于手势输入、互联网访问、环境音效、高质量的文本和图形的流畅且响应迅速的用户界面是成功移动应用程序的要素。

所有主流的移动操作系统都为软件开发者提供了不同方式接近硬件的开发可能。谷歌提供了 Android 原生开发工具包（NDK），以简化将其他平台上的现有应用程序和库移植到 Android，并利用现代移动设备提供的底层硬件性能。C 语言，尤其是 C++，都因其难学难写用户界面代码而闻名。这确实是事实，但仅当有人试图从零开始编写一切时。在这本书中，我们使用 C 和 C++编程语言，并将它们与久经考验的第三方库链接起来，以允许创建具有现代触摸界面和访问诸如 Facebook、Twitter、Flickr、Picasa、Instagram 等流行网站的代表性状态转移（REST）API 的内容丰富的应用程序。

尽管关于如何在用 Java 或.NET 语言编写的应用程序中使用互联网资源的信息已经很多，但在 C++编程语言中这样做却鲜有讨论。现代 OpenGL 版本要求投入足够努力来创建和使用最新的扩展。使用 OpenGL API 的编程通常在文献中以特定平台的方式描述。对于移动版本 OpenGL ES，事情变得更加复杂，因为开发者必须调整现有的着色器程序，使它们能在移动图形处理单元（GPU）上运行。在 C++中使用标准的 Android 设施进行声音播放也不是那么直接，例如，需要采取措施复用现有的 PC 代码以便于 OpenAL 库的使用。这本书试图阐明这些主题，并将许多有用的食谱结合起来，简化使用 Android NDK 的多平台友好开发。

Android 是一个基于 Linux 内核的移动操作系统，专为智能手机、平板电脑、上网本和其他便携设备设计。Android 的初步开发由 Android Inc 开始，该公司于 2005 年被 Google 收购。2007 年 11 月，第一个版本公布，然而，第一款基于 Android 的商业智能手机 HTC Dream 在 2008 年几乎一年后发布。

除了数字编号，Android 版本还有官方的代号名称——每个主要版本都是以甜点命名。以下是与 NDK 相关的 Android 平台技术和功能的一些重要里程碑：

+   **版本 1.5（纸杯蛋糕）**：这个 Android 版本首次发布了支持 ARMv5TE 指令的 Android 本地开发工具包。

+   **版本 1.6（甜甜圈）**：首次引入了 OpenGL ES 1.1 本地库支持。

+   **版本 2.0（闪电泡芙）**：支持 OpenGL ES 2.0 本地库。

+   **版本 2.3（姜饼）**：

    +   Dalvik VM 中的并发垃圾收集器。这提供了更快的游戏性能和改进的 OpenGL ES 操作效率。

    +   本地开发工具包的功能得到了极大的扩展，包括传感器访问、本地音频 OpenSL ES、EGL 库、活动生命周期管理和对资产的本地访问。

+   **版本 3.0（蜂巢）**：

    +   支持大型触摸屏的平板电脑

    +   支持多核处理器

+   **版本 4.0（冰淇淋三明治）**：

    +   统一的智能手机和平板界面

    +   硬件加速的 2D 渲染。VPN 客户端 API

+   **版本 4.1** 和 **4.2（果冻豆）**：

    +   这提高了渲染性能和三重缓冲

    +   支持外部显示器，包括通过 Wi-Fi 连接的外部显示器

    +   它们支持高动态范围相机

    +   新内置的开发者选项，用于调试和性能分析。Dalvik VM 运行时优化。

+   **版本 4.3（果冻豆）**：支持 OpenGL ES 3.0 本地库。

+   **版本 4.4（奇巧）**：从 NDK 引入了 RenderScript 的访问。此功能与运行 Android 2.2 或更高版本的任何设备向后兼容。

Android 本地开发工具包（NDK）用于需要 Dalvik 无法提供的性能的多媒体应用程序，以及直接访问本地系统库。NDK 也是可移植性的关键，反过来，它允许使用熟悉的工具（如 GCC 和 Clang 工具链或类似工具）进行相当舒适的开发和调试过程。NDK 的典型使用决定了本书的范围——集成一些最常用的 C/C++ 库，用于图形、声音、网络和资源存储。

最初，NDK 是基于 Bionic 库的。这是由 Google 为 Android 开发的 BSD 标准 C 库（libc）的一个衍生品。Bionic 的主要目标如下：

+   **许可**：原始 GNU C 库（glibc）是 GPL 许可的，而 Bionic 拥有 BSD 许可。

+   **大小**：与 GNU C 库相比，Bionic 的体积要小得多。

+   **速度**：Bionic 针对相对低时钟频率的移动 CPU 设计。例如，它有一个自定义的 pthreads 实现。

Bionic 在完整 libc 实现中缺少许多重要特性，例如 RTTI 和 C++ 异常处理支持。然而，NDK 提供了几个带有不同 C++ 辅助运行时的库，这些库实现了这些特性。这些包括 GAbi++ 运行时、STLport 运行时和 GNU 标准 C++库。除了基本的 POSIX 特性外，Bionic 还支持 Android 特定的机制，如日志记录。

NDK 是一种非常有效的方式来复用大量的现有 C 和 C++ 代码。

# 本书涵盖的内容

第一章，*建立构建环境*，解释了如何在 Microsoft Windows 和 Ubuntu/Debian Linux 发行版上安装和配置 Android SDK 和 NDK，以及如何在基于 Android 的设备上构建和运行你的第一个应用程序。你将学习如何使用 Android NDK 附带的不同的编译器和工具链。本章还涵盖了使用 adb 工具进行调试和部署应用程序的内容。

第二章，*移植通用库*，包含一系列将久经考验的 C++ 项目和 API 移植到 Android NDK 的方法，例如 FreeType 字体渲染库、FreeImage 图像加载库、libcurl 和 OpenSSL（包括编译 libssl 和 libcrypto）、OpenAL API、libmodplug 音频库、Box2D 物理库、Open Dynamics Engine (ODE)、libogg 和 libvorbis。其中一些需要对源代码进行修改，这将在文中解释。这些库中的大多数将在后续章节中使用。

第三章，*网络编程*，展示了如何使用知名的 libcurl 库通过 HTTP 协议下载文件，以及如何使用 C++ 代码直接向流行的 Picasa 和 Flickr 在线服务形成请求和解析响应。如今，大多数应用程序在某种程度上都会使用网络数据传输。HTTP 协议是所有流行网站（如 Facebook、Twitter、Picasa、Flickr、SoundCloud 和 YouTube）API 的基础。本章的剩余部分致力于 Web 服务器开发。在应用程序中拥有一个迷你 Web 服务器可以让开发者远程控制软件，监视其运行时，而不使用特定于操作系统的代码。本章开头还介绍了用于后台下载处理的任务队列和简单的智能指针，以允许跨线程高效交换数据。这些线程原语在第四章，*组织虚拟文件系统*和第五章，*跨平台音频流*中会被使用。

第四章, *组织虚拟文件系统*，完全致力于异步文件处理、资源代理和资源压缩。许多程序将其数据存储为一系列文件。在不阻塞整个程序的情况下加载这些文件是一个重要的问题。所有现代操作系统的人机界面指南规定应用程序开发者应避免在程序工作流程中出现任何延迟或“冻结”（在 Android 中称为应用程序无响应(ANR)错误）。Android 程序包只是带有.apk 扩展名的熟悉 ZIP 算法压缩的归档文件。为了允许直接从.apk 读取应用程序的资源文件，我们必须使用 zlib 库解压.zip 格式。另一个重要的话题是虚拟文件系统概念，它允许我们对底层的操作系统文件和文件夹结构进行抽象，并在 Android 和 PC 版本的应用程序之间共享资源。

第五章, *跨平台音频流*，从使用 OpenAL 库组织音频流开始。这之后，我们继续学习 RIFF WAVE 文件格式的读取，以及 OGG Vorbis 流的解码。最后，我们学习如何使用 libmodplug 播放一些追踪音乐。最近的 Android NDK 包括了 OpenSL ES API 的实现。然而，我们正在寻找一个完全可移植的实现，以便在桌面 PC 和其他移动平台之间实现无缝的游戏调试功能。为此，我们将 OpenAL 实现预编译成一个静态库，然后在 libogg 和 libvorbis 之上组织一个小型的多线程声音流库。

第六章，*统一 OpenGL ES 3 和 OpenGL 3*，介绍了桌面 OpenGL 3 和移动 OpenGL ES 3.0 的基本渲染循环。将应用程序重新部署到移动设备是一项耗时的操作，这阻止了开发者进行快速的功能测试和调试。为了允许在 PC 上开发游戏逻辑并进行调试，我们提供了一种技术，可以在移动 OpenGL ES 中使用桌面 GLSL 着色器。

第七章，*跨平台 UI 和输入系统*，将教你如何以可移植的方式实现多触摸事件处理和手势识别。如今，移动设备几乎与基于手势的触摸输入同义。没有图形用户界面（GUI）的现代面向用户的应用程序是无法存在的。组织交互有两个基本问题：输入和文本渲染。为了便于测试和调试，我们还展示了如何在配备了多个鼠标设备的 Windows 7 PC 上模拟多触摸输入。由于我们的目标是开发交互式游戏应用，我们必须以熟悉的方式实现用户输入。我们将系统地教你如何创建一个屏幕上的游戏手柄 UI。在一个全球多元文化环境中，任何应用程序拥有一个多语言文本渲染器是非常理想的。我们将展示如何使用 FreeType 库来渲染拉丁文、西里尔文和从左到右的文本。将介绍一个基于字典的方法来组织多语言 UTF-8 本地化界面。

第八章，*编写消除游戏*，将把我们介绍的所有技术整合在一起，编写一个简单的消除游戏，包括使用 OpenGL ES 进行渲染，处理输入，资源打包，以及 PC 端的调试。该游戏也可以在 Windows 桌面 PC 上运行和调试，并且可以轻松地移植到其他移动平台。

第九章，*编写拼图游戏*，将提供一个更复杂的示例，整合上述所有内容。关于图形和输入的所有上述元素都将使用本地网络库和 API 从 Picasa 在线服务下载图片。

# 本书中所需准备

本书以 Windows PC 为中心。由于模拟器在 3D 图形和原生音频方面的限制，建议使用 Android 智能手机或平板电脑。

### 注意

本书中的源代码基于开源的 Linderdaum 引擎，并提炼了该引擎中使用的一些方法和技巧。你可以访问[`www.linderdaum.com`](http://www.linderdaum.com)获取。

假设读者具备 C 或 C++的基础知识，包括指针操作、多线程和基本的面向对象编程概念。读者还应熟悉高级编程概念，如线程和同步原语，并对 GCC 工具链有基本的了解。我们还希望读者不害怕在没有 IDE（是的，在没有自动补全功能的 IDE 中开发绝对是一项技能）的情况下，例如从终端/FarManager/Notepad/SublimeText 进行开发。

本书不涉及 Android Java 开发。你需要阅读其他资料来熟悉这方面的内容。

对线性代数和 3D 空间中的仿射变换有一些实际了解对于理解 OpenGL 编程和手势识别很有帮助。

# 这本书适合谁

您想要将现有的 C/C++应用程序移植到 Android 吗？您是一位有经验的 C++开发者，想要跳入现代移动开发吗？您想要提高基于 Java 的 Android 应用程序的性能吗？您想在您的 Android 应用程序中使用 C++编写的优秀库吗？您想通过在 PC 上调试移动游戏来提高您的生产力吗？

如果您对这些问题中的任何一个回答“是”，那么这本书就是为您准备的。

# 构建源代码

本书的代码包中的示例可以使用以下命令进行编译：

+   对于 Windows：make all

+   对于 Android：ndk-buildant copy-common-media debug

# 约定

在这本书中，您会发现多种文本样式，这些样式用于区分不同类型的信息。以下是一些样式示例，以及它们含义的解释。

文本中的代码字会像这样显示："`JAVA_HOME`变量应指向 Java 开发工具包文件夹。"

代码块如下排版：

```kt
package com.packtpub.ndkcookbook.app1;
import android.app.Activity;
public class App1Activity extends Activity
{
};
```

当我们希望引起您对某行代码的注意时，相关的行会像这样被强调：

```kt
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <string name="app_name">App1</string>
</resources>
```

所有的命令行输入或输出都如下书写：

```kt
>adb.exe logcat -v time > 1.txt
```

**新术语**和**重要词汇**会用粗体显示。您在屏幕上看到的词，例如菜单或对话框中的，会像这样出现在文本中："选择是否安装这个设备软件，您应该点击**安装**按钮"。

### 注意

警告或重要说明会像这样出现在一个框里。

### 提示

提示和技巧会像这样出现。

# 读者反馈

我们始终欢迎读者的反馈。让我们知道您对这本书的看法——您喜欢或可能不喜欢的内容。读者的反馈对我们开发您真正能从中获得最大收益的标题非常重要。

如果您想要给我们发送一般性的反馈，只需发送电子邮件至`<feedback@packtpub.com>`，并在邮件的主题中提及书名。

如果您在某个主题上有专业知识，并且您有兴趣撰写或为书籍做贡献，请查看我们在[www.packtpub.com/authors](http://www.packtpub.com/authors)上的作者指南。

# 客户支持

既然您现在是 Packt 图书的骄傲拥有者，我们有一些事情可以帮助您充分利用您的购买。

## 下载本书的示例代码

您可以从您的账户下载您购买的所有 Packt 图书的示例源代码文件，网址是[`www.PacktPub.com`](http://www.PacktPub.com)。如果您在其他地方购买了这本书，可以访问[`www.PacktPub.com/support`](http://www.PacktPub.com/support)注册，我们会直接将文件通过电子邮件发送给您。我们努力为这本书编写和调试源代码。事实上，在现实生活中，代码中总是潜伏着 bug，需要在发布后修复。

我们建立了一个 GitHub 仓库，这样每个人都可以下载最新的源代码包，并通过提交 pull 请求来提交错误修复和改进。该仓库可以从以下位置克隆：[`github.com/corporateshark/Android-NDK-Game-Development-Cookbook`](https://github.com/corporateshark/Android-NDK-Game-Development-Cookbook)。我们源代码包的最新快照可以在以下链接获取：[`www.linderdaum.com/Android-NDK-Game-Development-Cookbook-SourceCodeBungle.zip`](http://www.linderdaum.com/Android-NDK-Game-Development-Cookbook-SourceCodeBungle.zip)。

## 错误更正

尽管我们已经尽力确保内容的准确性，但错误仍然会发生。如果你在我们的书中发现错误——可能是文本或代码中的错误——我们非常感激你能向我们报告。这样做，你可以让其他读者免受挫折，并帮助我们改进本书的后续版本。如果你发现任何错误，请通过访问 [`www.packtpub.com/support`](http://www.packtpub.com/support) 报告，选择你的书，点击错误更正提交表单链接，并输入错误详情。一旦你的错误更正被验证，你的提交将被接受，错误更正将在我们网站的相应标题下的错误更正部分上传或添加到现有错误列表中。任何现有的错误更正可以通过从 [`www.packtpub.com/support`](http://www.packtpub.com/support) 选择你的标题来查看。

## 盗版

在互联网上，版权材料的盗版是一个所有媒体都面临的持续问题。在 Packt，我们非常重视保护我们的版权和许可。如果你在互联网上以任何形式发现我们作品非法副本，请立即提供位置地址或网站名称，以便我们可以寻求补救措施。

请在提供疑似盗版材料链接的情况下，联系我们 `<copyright@packtpub.com>`。

我们感谢您保护我们的作者，以及我们为您带来有价值内容的能力。

## 问题

如果你在这本书的任何方面遇到问题，可以联系我们 `<questions@packtpub.com>`，我们将尽力解决。
