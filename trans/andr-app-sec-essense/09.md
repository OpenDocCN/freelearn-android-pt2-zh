# 第九章。安全性测试

这无疑是这本书最重要的一章。作为开发人员，我们都尽最大努力编写漂亮、可用和安全的代码。我们都经历过一个伟大想法的激动和看到它成功的冲动。我们也有疯狂的时间表和截止日期。所以 bug 会发生，测试 bug 是任何编码生命周期的自然组成部分。

今天的大多数测试案例都集中在可用性、功能性和压力测试上。在大多数情况下，测试工程师在测试安全性时会不知所措。当法规遵从性和安全性被忽略时，有时需要重新设计或再次实施应用程序。以出于完整性目的创建消息摘要为例。一个开发者可能会决定使用 SHA-1 来创建一个 160 位的摘要。在服务器端，数据库被设计为容纳 160 位数据。一个不道德的黑客闯入了应用程序。当执行安全审查时，确定 SHA-1 不够强大，不适合该用例，需要更新到 SHA-256。由于数据库的设计只能容纳 160 位，因此在客户端进行快速修复成为一项挑战，因为整个设计都必须更改。事情现在变得严重了。考虑到移动生态系统的快节奏和短暂性，这是对时间的浪费。

本章旨在介绍安全测试的概念。本章从测试概述开始。如果您已经熟悉测试，您可以轻松跳过这一部分。下一节将讨论安全性测试以及测试应用程序安全性的方法，即安全性审查、手动测试和使用工具的自动化测试。以下几节讨论了一些示例安全测试用例，它们可以作为编写测试的基准。本章最后讨论了开发人员和测试工程师可以用来开发测试用例和测试安全性的工具和资源。

# 测试概述

凭借各种不同功能、外形和版本的设备，安卓是最具挑战性的测试操作系统之一。获得基本功能和用户体验本身就是一个挑战。下图说明了通常在安卓应用程序开发环境中执行的测试。正如我们这个时代伟大的密码学家布鲁斯·施奈尔(Bruce Schneier)恰当地指出的那样，“安全性不是一个产品，而是一个过程”，所以你会注意到我已经将安全性测试添加到了应用程序测试的整个生命周期中。

![Testing overview](graphics/5603OT_09_01.jpg)

让我们花一点时间从安卓的角度来看每个类别、单元测试、集成测试和系统测试意味着什么。

*   **单元测试**:在大多数情况下，编写模块代码的开发人员开发单元测试。开发人员应该在将代码交给测试工程师之前编写和单元测试他们的模块。安卓软件开发工具包附带了用于单元测试的测试应用编程接口。这个框架是在 JUnit 上实现的，JUNit 是一个流行的 Java 单元测试框架。单元测试可以很容易地自动化。这些测试包括边界测试、输入验证测试以及与后端的连接。
*   **集成测试**:一旦单元测试完成，不同的组件被集成，就会进行集成测试，以确保不同的组件协同工作。这些测试是在组件捆绑在一起时执行的。让我们考虑两个团队分别工作，一个在登录模块，另一个在搜索结果页面。一旦模块开发完成，并且它们相互集成，就应该进行测试，将两个模块一起检查。如今，大多数开发环境使用连续集成来执行两个模块一起编译的健全性测试。
*   **System testing**: These are tests that test the whole application and how the application interacts with the Android platform. Some examples of system testing will include testing how search functions on different platforms and how differences in Android-based devices affect the display of search results.

    安全测试应在测试的每个阶段进行。例如，在单元测试级别，开发人员应该测试不一致和不正确的输入值、缓冲区溢出和用户的访问级别。

    在集成级别，工程师可以测试两个模块之间的安全数据传输以及传递错误数据的行为。

    在系统测试状态下，工程师可以在不同的安卓平台上测试他们的应用程序的外观和行为。就安卓而言，这是一个特别重要的测试阶段，因为不同供应商和运营商的安卓设备和堆栈能力存在差异。

    流程中前面提到的任何测试套件通常包含不同类型测试的混合。下图说明了这些情况。请注意，我再次在组合中添加了安全测试。

    ![Testing overview](graphics/5603OT_09_02.jpg)

*   **功能测试**:这些测试检查应用程序是否以预期的行为运行。例如，登录功能的功能性测试将测试用户输入用户名和密码并按下*进入*的情况；如果凭据有效，用户将登录到系统，或者显示错误。您可能希望验证是否使用不同的错误情况生成了正确的错误消息。
*   **Localization tests**: Most of the applications today are global and are available in different countries. To support different locales, an application has to be localized and internationalized. Localized refers to language translation and internationalization refers to adapting the application according to the norms of a particular locale. Consider a case of adapting a view that accepts addresses in Japanese (that is, you want to support Japan as a country). Localization will translate the word Address Line 1, Address Line 2, City, State, Zip, and Country into their Japanese equivalent. However, in Japan the addresses system is different from the Roman system and the view that accepts address will have to be redesigned and some labels might have to be shuffled around.

    安卓有一个非常用户友好的框架来存储字符串和本地化视图，开发人员应该加以利用。在新市场开发应用时，最好咨询本地化专家。

*   **可用性测试**:也叫 UI 测试，这些测试关注的是用户界面的观感，确保用户输入方便，读取屏幕上的信息，改变一个应用的美观度和大致流程。在屏幕空间受限的设备和不同屏幕尺寸的设备中，可用性非常重要。
*   **硬件兼容性测试**:这套测试将针对在不同设备上测试应用中使用的硬件特性。例如，如果应用程序使用设备摄像头，则应该执行测试来检查代码在具有不同聚焦能力的不同设备摄像头上是否正常工作。
*   **回归测试**:这些通常是自动化测试，在应用程序的每次变更后运行，以确保应用程序仍然按预期工作。例如，在书店应用程序中，您可以将关键功能确定为登录、注销、搜索书籍以及将书籍添加到愿望列表。每当添加新功能或更新现有功能时，都会执行这些健全性测试，以确保没有任何损坏。

安全测试将在以下章节中详细讨论。

正如您可能已经猜到的，这些测试用例中的大多数都是相互协同工作的。例如，为了测试一个新国家的地址页面，本地化和用户界面测试必须齐头并进。

# 安全测试基础

本章是安全测试的概述。我们讨论可以围绕其开发安全测试的安全支柱。第二部分讨论不同类型的安全测试。

## 安全原则

任何一种应用安全测试都应该遵循安全的六大原则，即认证、授权、可用性、保密性、完整性和不可否认性。我们已经在[第 6 章](06.html "Chapter 6. Your Tools – Crypto APIs")、*您的工具-加密 API*中介绍了这些概念的大部分以及如何实现它们。

![Security tenets](graphics/5603OT_09_03.jpg)

*认证* 是识别用户的尺度。您可以使用来自脸书、推特、领英和贝宝等公司的认证应用编程接口。使用的主要协议是 OAuth 和 OpenIDConnect。这些技术将认证任务从应用程序中卸下。对于应用程序开发人员和用户来说，这是一个双赢的条件。应用程序开发人员不必实现他们自己的方案，可以使用内置机制进行身份验证。用户不需要与他们不信任的应用程序共享个人信息。它对开发这种方案的公司很有用，因为它可以提高网站的流量。这些技术大多基于向用户提供身份验证令牌。

[第 10 章](10.html "Chapter 10. Looking into the Future")、*展望未来*，讨论了认证方面的一些新进展。

授权指的是访问控制——确定用户是否拥有访问资源的适当权限。就 Android 而言，这可以通过用权限保护应用程序组件并尽可能检查调用者身份来实现。

*可用性* 意味着数据应在需要时提供给授权的用户。使用广播和数据意图可以确保这种安全措施。

*保密* 指的是保证数据的安全，并且只将数据透露给目标方。加密数据，使用适当的权限，并遵守安卓沙盒可以帮助这种安全措施。

*完整性* 表示数据在传输中或静止时没有被修改。如果数据被篡改，可以识别这种篡改。添加邮件摘要、数字签名和加密数据，无论是在传输过程中还是在静止状态下，都有助于保持完整性。

*不可否认* 可以使用数字签名、时间戳和证书来实现，并且确定发送方不能否认发送数据。在[第 6 章](06.html "Chapter 6. Your Tools – Crypto APIs")*您的工具-加密应用程序接口*中讨论的数字版权管理已经实施，因此用户不能拒绝接收内容。

## 安全测试类别

牢记刚才讨论的安全原则，安全测试可以分为三个阶段:应用程序审查、手动测试和自动测试。

### 申请审核

安全测试的第一步是应用程序审查过程。这个过程侧重于理解应用程序，并识别硬件、不同的技术和应用程序使用的功能。一旦这些特征被识别，审查者试图访问这些能力中的安全漏洞。审查过程确定了清单文件中明显存在的问题、破损或弱加密技术的使用、协议的不安全使用以及开发过程中可能遗漏的技术和硬件中的安全问题。它涵盖了合规性和标准，以及它们是否得到了适当的遵守。

可以在清单文件中识别的安全问题的一些示例包括清单文件中应用程序不需要但出于调试目的而添加的多余权限、不使用权限保护组件、忘记关闭调试模式以及日志语句。

合规性基于用例。根据编写应用程序的用例，应用了不同的标准。例如，支付和商业用例应用程序可能正在查看 PCC-DSS。基于地理位置的应用程序必须知道隐私问题。

如今，有专门从事移动应用程序审查过程的安全审计公司。如果有疑问，你应该使用它们。

### 手动测试

手动安全测试，顾名思义，是在开发过程中或者由测试工程师手动完成的。工程师通过输入不同的输入来观察应用程序在不同场景下的行为。示例包括查看日志以验证没有敏感信息被泄露，多次前往前一个活动查看应用程序的执行情况，尝试破坏应用程序的身份验证方案，以及检查用户是否具有适当的访问权限。不能的场景也属于这一类。有一些公司比如 uTest([www.utest.com](http://www.utest.com))雇佣了手动测试人员，他们可以为你的应用程序执行手动测试。

### 动态测试

也被称为自动化测试，这些测试最好通过编写测试脚本来完成。输入验证、压力测试、模糊化和边界测试等测试可以很容易地自动化。这些测试中的大多数可以很容易地成为标准开发/测试周期的一部分，并且可以在添加新特性时作为健全性测试。你可能会决定使用安全公司的服务，比如专门从事这一领域的 Device Anywhere([www.deviceanywhere.com](http://www.deviceanywhere.com))。

# 测试用例场景示例

在这一节中，我试图从安全的角度列举一些有趣的示例测试案例。它们没有特定的顺序，在为您的特定用例识别测试用例时，您可以使用它们作为参考。

## 在服务器上测试

移动生态系统非常有趣；它还很年轻，还在发展中。应用程序可能想要向服务器发送一段数据，但是在服务器上接收到的数据可能会有很大不同。这可能是因为通信通道中的问题，黑客会在移动时窥探并更改内容，或者它可能是一个坏客户端。不管是什么原因，仅仅测试应用程序是不够的，服务器测试对于应用程序的安全性至关重要。这些测试的重点是，预期的内容是否在服务器端收到，PII 是否以明文形式存储在服务器上，业务逻辑是否驻留在客户端，以及它是否正常工作。我们在[第 6 章](06.html "Chapter 6. Your Tools – Crypto APIs")、*你的工具-加密应用程序接口*中也讨论过这个问题。

这个测试领域已经成熟，有大量的例子和工具可以在服务器上进行测试。使用端口扫描工具(如 Nmap)可以轻松检查开放端口和防火墙。

## 测试网络

基础设施层是移动设备的主干，让移动无处不在。它也带来了新的挑战和测试用例。设备使用不同的协议与服务器通信，每个设备都带有独特的安全漏洞包。GSM 很容易被破坏；无线网络本来就不安全，尤其是当你连接到一个流氓热点时。**长期演进** ( **LTE** ) 是高速无线数据通信的新标准，基于 IP，但尚未经过彻底测试，NFC、蓝牙、RFID 等邻近技术带来了完全不同的测试范式。因此，测试应用程序正在使用的技术并围绕它构建测试用例是非常重要的。

## 保护传输中的数据

如果你的应用使用**传输层安全** ( **TLS** )就好了，但是要确保是正确实现的，所以测试一下。测试客户端和服务器之间的所有通信都已加密，并且没有 PII 或秘密密钥被清晰地传输。请记住，序列化不是加密，混淆也不是加密。确保服务器正在检查证书验证和证书过期。检查正在使用的加密算法和协议是否是最新的，并且对于您的用例足够安全。

## 安全存储

最好不要在客户端存储敏感数据，如私钥、用户名、密码和其他 PII 信息。理想情况下，这些信息应该存储在服务器上。将密钥与其加密的数据存储在一起会破坏安全性。如果密钥必须存储在客户端上，首先它们不应该以明文存储。其次，它们不应该存储在文件、缓存文件或共享首选项中。密钥应存储在`keystore`中，密码应存储在`AccountManager`中，所有敏感信息应以加密方式存储。在大多数情况下，可以存储哈希值而不是密码。

## 行动前验证

验证在应用程序的不同组件之间以及从其他应用程序传递的输入、数据和调用者。任何活动都可以将任何类型的数据打包到意图中，接收组件有责任在对其进行操作之前进行测试和验证。我们在[第 2 章](02.html "Chapter 2. Application Building Blocks")、*应用构建模块*中详细讨论了这一点。这种情况下的测试将包括向组件传递无效和错误的数据，并观察它的行为。

在某些情况下，您可能能够在响应来电者的请求之前检查来电者的身份。用它！尤其是在启动敏感操作之前，请检查来电者身份和您将要处理的数据。

## 最小特权原则

此类别中的测试包括测试不同应用程序组件的权限，并确保具有正常运行所需的最低权限。这包括检查文件、缓存文件和`SharedPrferences`的可见性和可访问性权限。检查他们是否真的需要`MODE_WORLD_READABLE` 或`MODE_WORLD_WRITABLE` 的许可。

检查应用程序请求的权限。例如，如果不需要细粒度的位置访问，只需要请求粗粒度的权限，如果只需要读取短信，不要同时请求读取和写入短信权限。随着消费者越来越意识到移动领域的安全问题，如果您的应用程序请求没有意义的权限，他们可能会对其产生怀疑。图书浏览应用程序访问用户联系人列表和设备摄像头是没有意义的。

## 管理负债

了解你所在领域的规则和条例。陷入责任诉讼是一件麻烦的事情，最好远离它们。此外，如果使用专门处理这些问题的第三方工具和服务是有意义的，那么意味着使用它们。如果您的应用程序收集用户数据，请确保您已经获得用户的适当同意，并且您正在收集的所有内容都已列出。例如，加州在线隐私保护法规定，如果一个应用程序在加州收集信息，那么它应该被披露。

让我们再举一个处理支付的应用程序的用例。与其尝试自己做，不如使用现有的支付解决方案，如 PayPal。支付处理用户的钱，并且有诸如 PCI-DSS 这样的指令来管理如何使用这些功能。

同样，与其设计和开发您自己开发的安全算法和协议，不如使用经过时间测试和行业测试的安全套件和库。

请注意您支持的国家将如何使用该应用程序。不同的国家有不同的规章制度。PII 的定义也不同。

## 清理

第一，不记录敏感信息。在公开发布应用程序之前，请确保关闭调试。清除文件、cookies 和缓存中的所有敏感信息；也就是说，将内存归零。

## 可用性与安全性

平衡可用性和安全性是一门棘手而微妙的艺术。为了方便起见，应用程序可能会保留用户名、密码、和会话令牌，但这也使安全性变弱。如果您的应用程序中有一些记住用户身份的功能，请权衡便利性和安全性。您可以决定限制会话长度，并限制 cookies 和令牌保持活动的时间。

## 认证方案

这里的问题是要认证设备还是用户？设备确实会丢失或被盗。根据 IMEI、IMSI 或 UDID 等设备特征识别用户可能不是一个很好的身份验证方案。这些持续远程擦除和重置。您可能希望评估基于生物特征的认证机制或双因素认证方案来认证用户。

## 像黑客一样思考

像黑客一样思考，测试黑客会如何尝试黑你的应用程序。使用互联网上已经列出的可用工具和漏洞。使用黑客使用的工具测试应用程序可以揭示黑客在试图破解您的应用程序时会看到什么以及会获得什么信息。有一些工具，比如 Fiddler([【www.fiddler2.com】](http://www.fiddler2.com))可以用来通过你的应用监控网络流量。记住混淆代码不是安全的，这一点很重要。

## 谨慎整合

无论您是与硬件(内部和外部)还是第三方应用程序集成，都要小心。

如果应用程序使用一些硬件组件，如摄像头、蓝牙、NFC 芯片、加速度计、麦克风或全球定位系统，那么测试它们的安全性也很重要。任何硬件中的缺陷都会影响应用程序的整体安全性。

同样，第三方库中的一个 bug 可能会导致应用程序受损。当与这样一个外部库集成时，询问他们的测试结果，并在网上查找，寻求建议。

# 对资源进行安全测试

本节重点介绍可以创造性地用于测试应用程序安全性的工具、技术和一些其他资源。

## OWASP

**OWASP** ( **开放网络应用安全项目**)是一个致力于移动安全的组织。他们提供移动安全领域的工具和研究。查看他们在[https://www.owasp.org](https://www.owasp.org)的网站。这是一个寻找您的安全相关问题、为开源做出贡献以及创新和参与移动安全讨论的好地方。OWASP 每年都会编制一份前 10 大安全漏洞的列表，社区面临着解决这个问题的挑战。

## 安卓实用程序

安卓提供了一整套实用程序，可以创造性地用来测试应用程序。除了测试，这些工具还可以帮助开发人员调试他们的应用程序。

### 安卓调试桥

**安卓调试桥** ( **ADB** )可用于日志、内存检查等多种用途。查看开发者网站上 ADK 提供的功能完整列表。以下截图显示了亚行的一些实例:

![Android Debug Bridge](graphics/5603OT_09_04.jpg)

上一张截图显示了使用`adb logcat`命令的样本日志。

### 设置设备

要设置监控 web 应用程序的高级设置，您可以打开高级功能，这些功能可以帮助您在渗透测试期间获取更多数据。

![Setting up the device](graphics/5603OT_09_05.jpg)

前面的截图显示了如何启用 JavaScript 和插件来检查信息泄露。

### SQlite3

使用 SQLite3 实用程序，用户可以浏览它创建的数据库以及平台附带的一些其他数据库。

SQLite 实用程序允许用户查询数据库并检查数据库中的值。这样的数据库查询和检查可以明确指出诸如存储 PII 等问题。

### 达尔维克调试监控服务

**达尔维克调试监控服务** ( **DDMS** )是安卓框架提供的另一个重要工具。DDMS 提供了端口转发、屏幕捕获、线程和堆信息、`logcat`进程和无线电状态信息、来电和短信欺骗以及位置数据欺骗等功能。下面的截图显示了 DDMS 的窗口。查看安卓开发者网站上的功能细节。

![Dalvik Debug Monitor Service](graphics/5603OT_09_06.jpg)

还有其他一些第三方工具，如意图嗅探器和清单探索者，都是由 iSecPartners([https://www.isecpartners.com](https://www.isecpartners.com))开发的。其他 Linux 工具如`strace``procrank`也可以使用。为此，您可以使用 BusyBox，如下一节所述。

## BusyBox

BusyBox 被称为嵌入式 Linux 的瑞士军刀，提供了`vi`、`whoami`、`watchdog`等多个 Unix 工具。这些工具可以用于测试，而无需安装手机。在安卓系统上安装BusyBox 相当简单。只需从[www.busybox.net](http://www.busybox.net)下载即可。

![BusyBox](graphics/5603OT_09_07.jpg)

如上图截图所示，`busybox`可以轻松推送安装。安装后，Linux 命令可以很容易地执行。

## APK 分解者

对 APK 进行反编译并读取其内容相对容易。做这个练习将帮助你理解黑客将如何接近你的 APK。

APK 文件只不过是一个 ZIP 文件，将 APK 文件重命名为 ZIP 文件将允许您使用任何 ZIP 文件资源管理器打开它。这些都可以在`/data/app`目录下找到。您可以使用`adb pull`命令将其拉到您的机器上。在那里，您可以看到清单文件、资源、资产和其他内容。

![Decompile APK](graphics/5603OT_09_08.jpg)

接下来，使用安卓提供的`dexdump`工具，可以转储`/data/dalvik-cache`目录下的类。

![Decompile APK](graphics/5603OT_09_09.jpg)

例如，要将`data@app@com.example.example1-1.apk@classes.dex` 转储到名为`dump`的文件中，要使用的命令是:

```
dexdump –d –f –h data@app@com.example.example1-1.apk@classes .dex > dump

```

以下是转储文件中收集的数据类型的屏幕截图:

![Decompile APK](graphics/5603OT_09_10.jpg)

这个转储将以跳转语句的形式出现，很难阅读。像`baksmali` 或`dedexer` 这样的 DEX 去编译器可以用来使这些文件更具可读性。

# 总结

安全测试是一个相对年轻的领域。模式和测试策略仍在开发中，安全性被认为是识别应用程序弱点和提高应用程序质量的重要基准。在这一章中，我们总结了我们从前面章节中学到的知识，并使用它来为我们的应用程序定义测试用例。这只是一个开始，您应该定义您认为适合您的用例的测试用例。

我们从测试基础的概述开始。然后，我们讨论了设计测试用例时所围绕的六大安全支柱。讨论了一些示例测试用例，它们应该为您测试应用程序提供基础。然后，我们结束了这一章，讨论了可以用于安全测试的资源和工具。

现在让我们前进到这本书的最后一章，看看安卓领域有什么新的和正在发生的挑战我们安全基础的事情。